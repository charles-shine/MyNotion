# 存储过程

## 存储过程的概念

存储过程是一组为了完成特定功能的SQL语句集，经编译后存储在数据库中，用户通过指定存储过程的名字并给出参数（如果带有参数的话）来执行它。

> 存储过程的好处
>
> 1. 使用存储过程可以加快程序的运行速度
> 2. 使用存储过程可以减少网络流量
> 3. 存储过程可以提高数据库的安全性
>
> 坏处：
>
> ​	会加重服务器的负担
>
> 简单说：存储过程对传输有利，对服务器无利

## 存储过程的分类

### 系统存储过程

内置的存储过程，存储在master库中，主要用于执行某些管理功能与显示有关数据库和用户的信息。以sp_开头，可以在任何数据库中执行系统存储过程。

### 用户存储过程

用户自行创建并存储在用户数据库中的存储过程。

> 一次创建多次复用，执行速度快，节省网络流量

## 创建存储过程

### 不带参数的存储过程

create proc[edure] 存储过程名称prc

as

begin

​	SQL代码

end

### 带有输入参数的存储过程

create proc[edure] 存储过程名称

[{@参数 数据类型} [= 默认值] [，...n]]        *参数名一般与其对应的列名一致*

as

​	SQL语句[...n]

*存储过程的输入参数是由用户需要提供的实际参数决定*

*用户输入的实际参数必须与形参数量与类型完全一致,且必须赋值不得为空*

### 带有通配符参数的存储过程

create proc[edure] 存储过程名称

[{@参数 数据类型} [= %默认值%] [，...n]]        *参数名一般与其对应的列名一致*

as

​	SQL语句[...n]

**不能使用=等号来比较，只能使用like 模糊匹配**

*执行时无需加参数，直接执行*

## 存储过程的执行（调用）

exec 存储过程名称 实参[,...n]

## TRY-CATCH错误处理结构

begin try

​	SQL语句...   //运行代码

end try

begin catch

​	错误处理代码

end catch

*try-catch可以嵌套使用*

## IF EXISTS语句

用于判断某条信息是否存在

if exists（参数或表达式）

​	//处理代码

else

​	//信息不存在

*IF EXISTS可以嵌套使用*

## 存储过程框架结构

create proc 存储过程名

@参数名 参数类型[,...n]

as

begin try

​	if exists（）

​	begin

​		//执行功能

​	end

​	else

​		//信息不存在

end try

begin catch

​		//错误提示信息

end catch

## 存储过程的返回值

可以在存储过程中使用return语句返回一个值。

### 带有返回值的存储过程

return value

注意：value：返回整数值

### 执行带有返回值的存储过程

declare @Return Value int

exec @Return Value = 存储过程名 参数[,...n]

print @ Return Value

> return语句只能返回单值且是整数值，一般使用return语句返回状态值

## 输出参数

存储过程的参数分为**输入参数**和**输出参数**两种，输入参数用于向存储过程中带入数据，而输出参数将存储过程中的数据返回到调用程序。

### 创建存储过程的参数

~~~sql
@参数名 数据类型[=默认值][output][,...n]
~~~

### 执行带有输出参数的存储过程

~~~sql
decalre @输出参数 输出参数类型[,...n]
exec 存储过程名 @输入参数[,...n]，@输出参数 output[,...n]
print @输出参数1
print @输出参数2
…………
print @输出参数n
~~~

> 输出参数在调用存储过程时不会有值。
>
> 调用时参数列表需与声明存储过程的参数列表一 一 对应。
>
> 字符串只能与字符或字符串使用+相连。

## 存储过程调用存储过程

两个有调用关系的存储关系，**两者的输入参数列表完全一致**，**被调用存储关系输出参数不在调用存储过程中出现**，如果调用存储过程不在被调用，则无其他输出参数。

![HLtmv.png](https://s1.328888.xyz/2022/05/10/HLtmv.png)

## 修改存储过程

~~~sql
alter proc[edure] 存储过程名
[{@参数名 数据类型}[=默认值][output][,...n]]
as
	sql语句[,...n]
~~~

## 删除存储过程

~~~sql
drop proc 存储过程名
~~~

